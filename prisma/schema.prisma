generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone     String?  @unique @db.VarChar(20)
  email     String?  @unique @db.VarChar(255)
  name      String?  @db.VarChar(100)
  role      UserRole @default(CUSTOMER)
  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone])
  @@index([email])
  @@index([role])
  @@map("users")
}

model Category {
  name             String     @db.VarChar(100)
  createdAt        DateTime   @default(now())
  description      String?
  displayOrder     Int        @default(0)
  imageUrl         String?    @db.VarChar(500)
  isActive         Boolean    @default(true)
  parentCategoryId String?    @db.Uuid
  slug             String     @unique @db.VarChar(100)
  updatedAt        DateTime   @updatedAt
  id               String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  parentCategory   Category?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories  Category[] @relation("CategoryHierarchy")
  menuItems        MenuItem[]

  @@index([parentCategoryId])
  @@index([isActive])
  @@map("categories")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model MenuItem {
  name               String                  @db.VarChar(200)
  description        String?
  allergens          String[]
  availableQuantity  Decimal?                @db.Decimal(10, 3)
  basePrice          Decimal                 @db.Decimal(10, 2)
  categoryId         String                  @db.Uuid
  createdAt          DateTime                @default(now())
  customizationType  CustomizationType       @default(NONE)
  dietaryTags        String[]
  imageUrl           String?                 @db.VarChar(500)
  isAvailable        Boolean                 @default(true)
  maxQuantity        Decimal?                @db.Decimal(10, 3)
  minQuantity        Decimal                 @default(1.000) @db.Decimal(10, 3)
  prepTime           Int?
  quantityType       QuantityType            @default(UNIT)
  slug               String                  @unique @db.VarChar(200)
  stepQuantity       Decimal                 @default(1.000) @db.Decimal(10, 3)
  unit               String?                 @db.VarChar(20)
  updatedAt          DateTime                @updatedAt
  id                 String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customizationNodes CustomizationNode[]
  customizations     MenuItemCustomization[]
  taxes              MenuItemTax[]
  category           Category                @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems         OrderItem[]

  @@index([categoryId])
  @@index([isAvailable])
  @@index([basePrice])
  @@index([slug])
  @@index([categoryId, isAvailable, basePrice])
  @@index([dietaryTags], type: Gin)
  @@index([allergens], type: Gin)
  @@index([description(ops: raw("gin_trgm_ops"))], map: "idx_menu_items_description_trgm", type: Gin)
  @@index([name(ops: raw("gin_trgm_ops"))], map: "idx_menu_items_name_trgm", type: Gin)
  @@map("menu_items")
}

model Tax {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String        @db.VarChar(100)
  type         TaxType
  value        Decimal       @db.Decimal(10, 4)
  isActive     Boolean       @default(true)
  isInclusive  Boolean       @default(false)
  displayOrder Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  menuItems    MenuItemTax[]
  orderTaxes   OrderTax[]

  @@index([isActive])
  @@map("taxes")
}

model MenuItemTax {
  menuItemId String   @db.Uuid
  taxId      String   @db.Uuid
  applyOrder Int      @default(0)
  createdAt  DateTime @default(now())
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  tax        Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@id([menuItemId, taxId])
  @@index([menuItemId])
  @@map("menu_item_taxes")
}

model Customization {
  id        String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String                  @db.VarChar(100)
  type      SimpleCustomizationType
  price     Decimal                 @default(0.00) @db.Decimal(10, 2)
  isActive  Boolean                 @default(true)
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  menuItems MenuItemCustomization[]

  @@index([type])
  @@index([isActive])
  @@map("customizations")
}

model MenuItemCustomization {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  menuItemId      String        @db.Uuid
  customizationId String        @db.Uuid
  isRequired      Boolean       @default(false)
  minSelections   Int           @default(0)
  maxSelections   Int           @default(1)
  displayOrder    Int           @default(0)
  createdAt       DateTime      @default(now())
  customization   Customization @relation(fields: [customizationId], references: [id], onDelete: Cascade)
  menuItem        MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, customizationId])
  @@index([menuItemId])
  @@map("menu_item_customizations")
}

model CustomizationNode {
  id                      String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  menuItemId              String                   @db.Uuid
  type                    NodeType
  name                    String                   @db.VarChar(100)
  description             String?
  price                   Decimal                  @default(0.00) @db.Decimal(10, 2)
  data                    Json?
  displayOrder            Int                      @default(0)
  isActive                Boolean                  @default(true)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  childEdges              CustomizationEdge[]      @relation("ChildNode")
  parentEdges             CustomizationEdge[]      @relation("ParentNode")
  menuItem                MenuItem                 @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  orderItemCustomizations OrderItemCustomization[]

  @@index([menuItemId])
  @@index([type])
  @@index([isActive])
  @@map("customization_nodes")
}

model CustomizationEdge {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  parentNodeId String            @db.Uuid
  childNodeId  String            @db.Uuid
  edgeType     EdgeType          @default(HAS_OPTION)
  constraints  Json?
  displayOrder Int               @default(0)
  createdAt    DateTime          @default(now())
  childNode    CustomizationNode @relation("ChildNode", fields: [childNodeId], references: [id], onDelete: Cascade)
  parentNode   CustomizationNode @relation("ParentNode", fields: [parentNodeId], references: [id], onDelete: Cascade)

  @@unique([parentNodeId, childNodeId])
  @@index([parentNodeId])
  @@index([childNodeId])
  @@map("customization_edges")
}

model Order {
  userId  String? @db.Uuid
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)  
  subtotal            Decimal              @db.Decimal(10, 2)
  createdAt           DateTime             @default(now())
  estimatedPrepTime   Int?
  orderNumber         String               @unique @db.VarChar(50)
  sessionId           String               @db.VarChar(255)
  specialInstructions String?
  taxAmount           Decimal              @default(0.00) @db.Decimal(10, 2)
  totalAmount         Decimal              @db.Decimal(10, 2)
  updatedAt           DateTime             @updatedAt
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status              OrderStatus          @default(RECEIVED)
  items               OrderItem[]
  statusHistory       OrderStatusHistory[]
  taxes               OrderTax[]
  payment             Payment?

  @@index([sessionId])
  @@index([userId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@index([createdAt(sort: Desc)], map: "idx_orders_created")
  @@index([sessionId, status], map: "idx_orders_session_status")
  @@map("orders")
}

model OrderItem {
  quantity            Decimal                  @db.Decimal(10, 3)
  createdAt           DateTime                 @default(now())
  customizationTotal  Decimal                  @default(0.00) @db.Decimal(10, 2)
  itemBasePrice       Decimal                  @db.Decimal(10, 2)
  itemName            String                   @db.VarChar(200)
  itemSubtotal        Decimal                  @db.Decimal(10, 2)
  itemTaxAmount       Decimal                  @default(0.00) @db.Decimal(10, 2)
  itemTotal           Decimal                  @db.Decimal(10, 2)
  menuItemId          String                   @db.Uuid
  orderId             String                   @db.Uuid
  prepTime            Int?
  quantityType        QuantityType
  specialInstructions String?
  unit                String?                  @db.VarChar(20)
  id                  String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customizations      OrderItemCustomization[]
  menuItem            MenuItem                 @relation(fields: [menuItemId], references: [id])
  order               Order                    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([menuItemId, createdAt(sort: Desc)], map: "idx_order_items_analytics")
  @@index([menuItemId], map: "idx_order_items_menu_item")
  @@index([orderId], map: "idx_order_items_order")
  @@map("order_items")
}

model OrderItemCustomization {
  id                  String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderItemId         String             @db.Uuid
  customizationName   String             @db.VarChar(100)
  customizationType   String             @db.VarChar(20)
  customizationPrice  Decimal            @db.Decimal(10, 2)
  customizationNodeId String?            @db.Uuid
  createdAt           DateTime           @default(now())
  customizationNode   CustomizationNode? @relation(fields: [customizationNodeId], references: [id])
  orderItem           OrderItem          @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@map("order_item_customizations")
}

model OrderTax {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId          String   @db.Uuid
  taxId            String   @db.Uuid
  taxName          String   @db.VarChar(100)
  taxType          TaxType
  taxValue         Decimal  @db.Decimal(10, 4)
  calculatedAmount Decimal  @db.Decimal(10, 2)
  createdAt        DateTime @default(now())
  order            Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tax              Tax      @relation(fields: [taxId], references: [id])

  @@index([orderId])
  @@map("order_taxes")
}

model OrderStatusHistory {
  notes     String?
  changedBy String?     @db.VarChar(100)
  createdAt DateTime    @default(now())
  orderId   String      @db.Uuid
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status    OrderStatus
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)], map: "idx_order_status_history_created")
  @@index([orderId, createdAt(sort: Desc)], map: "idx_order_status_history_order_created")
  @@map("order_status_history")
}

model Payment {
  amount          Decimal       @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  gatewayResponse Json?
  orderId         String        @unique @db.Uuid
  paymentMethod   String        @db.VarChar(50)
  transactionId   String?       @unique @db.VarChar(100)
  updatedAt       DateTime      @updatedAt
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status          PaymentStatus @default(PENDING)
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([transactionId])
  @@map("payments")
}

enum QuantityType {
  UNIT
  WEIGHT
  VOLUME
  SERVING
}

enum CustomizationType {
  NONE
  SIMPLE
  COMPLEX_DAG
}

enum SimpleCustomizationType {
  SIZE
  ADDON
  MODIFIER
  OPTION
}

enum TaxType {
  PERCENTAGE
  FIXED
}

enum NodeType {
  GROUP
  OPTION
  MODIFIER
}

enum EdgeType {
  HAS_OPTION
  REQUIRES
  EXCLUDES
}

enum OrderStatus {
  RECEIVED
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum UserRole {
  CUSTOMER
  KITCHEN_STAFF
  ADMIN
}
